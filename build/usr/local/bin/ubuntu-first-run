#!/bin/bash
# ubuntu-first-run.sh
# Version: $(cat "$(dirname "$0")/../VERSION")
# Author: Jesse Hawkins
# License: GPLv3
#
# Purpose:
#   Interactive post-install setup tool for Ubuntu Server 24.04+.
#   Provides a checklist of setup actions to apply (e.g., shell prompt update),
#   tracks changes, and stores rollback points.
#
# Usage:
#   sudo ./src/ubuntu-first-run.sh

set -e

# Load version
VERSION=$(cat "$(dirname "$0")/../VERSION")

# Function: Update shell prompt
update_shell_prompt() {
  local bashrc="/home/$SUDO_USER/.bashrc"
  local backup="/home/$SUDO_USER/.bashrc.bak.$(date +%Y%m%d%H%M%S)"

  # Back up current .bashrc
  cp "$bashrc" "$backup"
  echo "üîÅ Backed up .bashrc to $backup"

  # Append our custom prompt settings
  cat << 'EOF' >> "$bashrc"

# --- Custom vertical shell prompt added by ubuntu-first-run ---
PS1='\u@\h\n\w\n\$ '
EOF

  echo "‚úÖ Shell prompt updated for user $SUDO_USER"
}

# Function: Show checklist
show_checklist() {
  echo "ubuntu-first-run version $VERSION"
  echo "-----------------------------------------"
  echo "Select the actions to perform:"
  echo "[Y] 01. Update shell prompt"
  echo ""

  read -p "Run 01 (update shell prompt)? [Y/n]: " update_prompt
  update_prompt=${update_prompt:-Y}
}

# Function: Confirm and run selected actions
run_selected_actions() {
  echo ""
  echo "Summary of actions to perform:"
  if [[ "$update_prompt" =~ ^[Yy]$ ]]; then
    echo "‚úî Update shell prompt"
  else
    echo "‚úò Skip shell prompt update"
  fi

  echo ""
  read -p "Continue with these changes? [Y/n]: " confirm
  confirm=${confirm:-Y}

  if [[ "$confirm" =~ ^[Yy]$ ]]; then
    [[ "$update_prompt" =~ ^[Yy]$ ]] && update_shell_prompt
    echo ""
    echo "‚úÖ All selected tasks completed."
  else
    echo "‚ùå Aborted by user."
    exit 0
  fi
}

# Ensure the script is run with sudo
if [[ "$EUID" -ne 0 ]]; then
  echo "‚ö†Ô∏è  Please run this script using sudo."
  exit 1
fi

# Entry point
show_checklist
run_selected_actions
